# 更新：调研工具文件写入功能

**日期**: 2026-02-21
**类别**: 功能 / 工具

## 概述

新增 `research_write_file` 工具，使 Researcher Agent 能够将调研结果保存到文件。该工具支持覆盖和追加两种写入模式，自动创建目录，适用于保存调研报告、方案文档等场景。

## 新功能

### 文件写入工具 (`research_write_file`)

**功能特性**：
- 支持写入 markdown 格式文件（或其他文本格式）
- 支持覆盖（overwrite）和追加（append）两种模式
- 自动创建目录（如目录不存在）
- 支持相对路径和绝对路径
- 返回文件路径和写入状态信息

**参数说明**：
- `path` (必需): 文件路径（相对路径或绝对路径）
- `content` (必需): 要写入的文件内容
- `mode` (可选): 写入模式，`overwrite`（覆盖，默认）或 `append`（追加）

**返回信息**：
- `success`: 是否成功
- `path`: 写入文件的绝对路径
- `message`: 操作结果消息（包含模式和文件大小）

## 修改的组件

### 新增文件
- `tools/research/write_file.go`：文件写入工具实现
  - `WriteFileRequest` / `WriteFileResponse` 结构体定义
  - `WriteFile` 函数：核心写入逻辑
  - `NewWriteFileTool` 工厂函数：创建工具实例

### 更新的文件
- `tools/tools.go`：在 `BaseTools` 函数中注册 `research_write_file` 工具

## 实现细节

### 核心逻辑

1. **路径处理**：
   - 验证路径不为空
   - 转换为绝对路径
   - 提取目录路径

2. **目录创建**：
   - 使用 `os.MkdirAll` 创建目录（权限 0755）
   - 如果目录已存在则跳过

3. **文件写入**：
   - **覆盖模式**：使用 `os.Create` 创建/覆盖文件
   - **追加模式**：使用 `os.OpenFile` 以追加模式打开文件
   - 文件权限设置为 0644

4. **错误处理**：
   - 路径验证错误
   - 目录创建错误
   - 文件打开错误
   - 写入错误

### 代码示例

```go
// 覆盖模式写入
{
  "path": "docs/research/方案.md",
  "content": "# 调研方案\n\n...",
  "mode": "overwrite"
}

// 追加模式写入
{
  "path": "docs/research/日志.md",
  "content": "\n## 2026-02-21\n\n...",
  "mode": "append"
}
```

## 使用场景

1. **保存调研报告**：将 Agent 生成的调研方案保存为 markdown 文件
2. **记录调研日志**：追加模式记录调研过程中的发现
3. **生成文档**：将代码分析结果保存为文档
4. **导出结果**：将 Agent 的执行结果导出到文件

## 配置

无需额外配置，工具会自动通过 `BaseTools` 函数加载。

## 依赖

- `os` - 文件系统操作
- `path/filepath` - 路径处理
- `github.com/cloudwego/eino/components/tool` - Eino 工具框架
- `github.com/cloudwego/eino/components/tool/utils` - 工具工具函数

## 注意事项

1. **文件权限**：写入的文件权限为 0644，目录权限为 0755
2. **路径安全**：建议使用相对路径，避免写入系统关键目录
3. **内容大小**：大文件写入可能影响性能，建议控制单次写入内容大小
4. **并发安全**：追加模式下，多线程并发写入同一文件可能导致内容交错

## 测试建议

1. 测试覆盖模式写入新文件
2. 测试覆盖模式覆盖已存在文件
3. 测试追加模式追加到已存在文件
4. 测试自动创建目录功能
5. 测试相对路径和绝对路径
6. 测试错误处理（无效路径、权限不足等）

## 相关文件

- `tools/research/write_file.go` - 工具实现
- `tools/tools.go` - 工具注册
- `tools/research/general_researcher.go` - 参考实现模式

## 参考

- DigFlow 更新文档：`DigFlow/updates/2026-02-21_Researcher应用能力增强.md`
- 能力对比分析：`.cursor/plans/researcher应用能力对比分析_7633bfea.plan.md`
